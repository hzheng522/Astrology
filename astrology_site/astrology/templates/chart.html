{% extends "astrology/base.html" %}

{% block title %}Chart | Astrology{% endblock %}

{% block content %}
<!-- templates/astrology/chart.html -->

<h2>Generate Your Birth Chart</h2>

<form id="birthChartForm">
  <label>Name: <input type="text" id="name"></label><br>
  <label>Birth Date: <input type="date" id="birthDate"></label><br>
  <label>Birth Time: <input type="time" id="birthTime"></label><br>
  <label>Latitude: <input type="number" id="latitude" step="any"></label><br>
  <label>Longitude: <input type="number" id="longitude" step="any"></label><br>
  <label>Time Zone: <input type="number" id="timezone" step="any"></label><br>
  <button type="submit">Generate</button>
</form>

<pre id="output"></pre>

<script>
document.getElementById('birthChartForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const [year, month, day] = document.getElementById('birthDate').value.split('-');
  const [hour, min] = document.getElementById('birthTime').value.split(':');

  const data = {
    day: parseInt(day),
    month: parseInt(month),
    year: parseInt(year),
    hour: parseInt(hour),
    min: parseInt(min),
    lat: parseFloat(document.getElementById('latitude').value),
    lon: parseFloat(document.getElementById('longitude').value),
    tzone: parseFloat(document.getElementById('timezone').value),
  };

  const userId = '639878';  
  const apiKey = '96f03ec92d46776d0476ac84cfe7fe29fb638089';
  const language = 'en';
  const api = 'natal_wheel_chart';

  const auth = "Basic " + btoa(userId + ":" + apiKey);

  fetch(`https://json.astrologyapi.com/v1/${api}`, {
    method: 'POST',
    headers: {
      'Authorization': auth,
      'Content-Type': 'application/json',
      'Accept-Language': language
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(json => {
    console.log(json);

    // Clear previous output
    const output = document.getElementById('output');
    output.textContent = '';

    // Check if the response contains the image URL
    if (json.chart_url) {
      // Create an <img> element and set its src to the chart URL
      const img = document.createElement('img');
      img.src = json.chart_url;
      img.alt = 'Birth Chart';
      img.style.maxWidth = '100%'; // Optional: Make the image responsive
      output.appendChild(img);
    } else {
      output.textContent = 'No chart URL found in the response.';
    }
  })
  .catch(err => {
    console.error(err);
    document.getElementById('output').textContent = 'Something went wrong!';
  });
});
</script>

{% endblock %}